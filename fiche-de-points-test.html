<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Airea – Fiche de points de mesure</title>
  <style>
    :root {
      --airea-blue: #003a80;
      --airea-light: #e6f2fa;
      --airea-border: #ccc;
      --border-radius: .5rem;
      --font-base: .9rem;
      --app-max-width: 480px;
      --box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      --green: #28a745;
      --error-red: #d9534f;
    }
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      font-family:'Segoe UI',sans-serif;
      background:var(--airea-light);
      display:flex; align-items:center; justify-content:center;
    }
    .app {
      width:100%; max-width:var(--app-max-width);
      height:100%; display:flex; flex-direction:column;
      background:#fff; box-shadow:var(--box-shadow);
    }
    header {
      display:flex; justify-content:space-between; align-items:center;
      background:var(--airea-blue); color:#fff;
      padding:.4rem 1rem;
    }
    header h1 { margin:0; font-size:.95rem; font-weight:400; }
    header input {
      width:100px; text-align:center;
      border:none; border-radius:var(--border-radius);
      padding:.4rem; font-size:.85rem;
    }
    main {
      flex:1; padding:1rem; overflow-y:auto;
    }
    #errors { color:var(--error-red); margin-bottom:1rem; }
    #errors ul { padding-left:1.2rem; margin:0; }
    label {
      display:block; margin-bottom:.3rem;
      font-size:var(--font-base); font-weight:500; color:#333;
    }
    select, input[type=text], input[type=datetime-local],
    input[type=number], button {
      width:100%; padding:.6rem;
      border:1px solid var(--airea-border);
      border-radius:var(--border-radius);
      font-size:var(--font-base);
      box-shadow:var(--box-shadow);
      box-sizing:border-box;
    }
    .row { margin-bottom:1rem; }
    .coords {
      display:grid; grid-template-columns:1fr 1fr; gap:1rem;
      margin-bottom:1rem;
    }
    .photos {
      display:grid; grid-template-columns:repeat(2,1fr); gap:1rem;
      margin-bottom:1rem;
    }
    .photos button {
      position:relative; display:flex; align-items:center; justify-content:center;
      background:#fff; transition:.2s;
    }
    .photos .btn-check {
      position:absolute; top:.4rem; right:.4rem;
      font-size:1.2rem; color:limegreen; display:none;
    }
    .photos button.filled {
      background:var(--airea-blue); color:#fff; border-color:var(--airea-blue);
    }
    .photos button.filled .btn-check { display:block; }
    .sensors {
      display:grid; grid-template-columns:repeat(3,1fr); gap:1rem;
      margin-bottom:1rem;
    }
    .sensors div { display:flex; flex-direction:column; }
    .footer {
      height:3.5rem; display:flex; align-items:center; justify-content:space-between;
      padding:0 .5rem; background:#f9f9f9; border-top:1px solid var(--airea-border);
    }
    .footer button {
      flex:1; margin:0 .25rem; border:none; cursor:pointer;
      border-radius:var(--border-radius); padding:.6rem; font-size:.95rem;
      box-shadow:var(--box-shadow);
    }
    #savePoint { background:var(--green); color:#fff; }
    #exportXlsx { background:var(--airea-blue); color:#fff; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Airea | Fiche de points de mesure</h1>
      <input id="affaire" value="AF25XX">
    </header>
    <main>
      <div id="errors"></div>
      <form id="pointForm" novalidate>
        <!-- Point de mesure -->
        <div class="row">
          <label for="pointSelect">Point de mesure</label>
          <select id="pointSelect">
            <option value="">-- Choisir --</option>
          </select>
        </div>
        <!-- Typologie -->
        <div class="row">
          <label for="typologySelect">Typologie</label>
          <select id="typologySelect">
            <option value="">-- Choisir --</option>
            <option value="Trafic">Trafic</option>
            <option value="Fond urbain">Fond urbain</option>
            <option value="Fond périurbain">Fond périurbain</option>
            <option value="Fond rural">Fond rural</option>
          </select>
        </div>
        <!-- Bouton géoloc -->
        <div class="row">
          <button type="button" id="btnGeo">Obtenir adresse & coordonnées</button>
        </div>
        <!-- Adresse & coordonnées -->
        <div class="row">
          <label for="address">Adresse</label>
          <input id="address" type="text" readonly>
        </div>
        <div class="coords">
          <div>
            <label for="latDMS">Latitude</label>
            <input id="latDMS" type="text" readonly>
          </div>
          <div>
            <label for="lngDMS">Longitude</label>
            <input id="lngDMS" type="text" readonly>
          </div>
        </div>
        <!-- Photos -->
        <div class="photos">
          <button type="button" id="photo1Btn">Photo 1<span class="btn-check">✓</span></button>
          <button type="button" id="photo2Btn">Photo 2<span class="btn-check">✓</span></button>
          <!-- on conserve les inputs cachés pour la capture -->
          <input type="file" id="photo1" accept="image/*" capture="environment" style="display:none">
          <input type="file" id="photo2" accept="image/*" capture="environment" style="display:none">
        </div>
        <!-- Capteurs -->
        <div class="sensors">
          <div><label for="no2">NO₂</label><input id="no2" type="number"></div>
          <div><label for="c6h6">C₆H₆</label><input id="c6h6" type="number"></div>
          <div><label for="pm10">PM₁₀</label><input id="pm10" type="number"></div>
        </div>
        <!-- Date & heure -->
        <div class="row">
          <label for="datetime">Date & heure</label>
          <input id="datetime" type="datetime-local" required>
        </div>
      </form>
    </main>
    <footer class="footer">
      <button type="button" id="savePoint">Enregistrer</button>
      <button type="button" id="exportXlsx" disabled>Export en .xlsx</button>
    </footer>
  </div>

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/blueimp-load-image/js/load-image.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // raccourcis
    const get = id => document.getElementById(id);
    const pointSelect    = get('pointSelect'),
          typologySelect = get('typologySelect'),
          btnGeo         = get('btnGeo'),
          btnSave        = get('savePoint'),
          btnExport      = get('exportXlsx'),
          addressEl      = get('address'),
          latEl          = get('latDMS'),
          lngEl          = get('lngDMS'),
          no2El          = get('no2'),
          c6h6El         = get('c6h6'),
          pm10El         = get('pm10'),
          datetimeEl     = get('datetime'),
          photo1        = get('photo1'),
          photo2        = get('photo2'),
          photo1Btn     = get('photo1Btn'),
          photo2Btn     = get('photo2Btn'),
          errorsDiv      = get('errors'),
          affaireEl      = get('affaire');

    // conversion cm→px & tailles
    const cmToPx = cm => Math.round(cm/2.54*96);
    const PHOTO_W_CM = 5.25, PHOTO_H_CM = 7, COL_W_CM = 5.5;
    const TARGET_W = cmToPx(PHOTO_W_CM), TARGET_H = cmToPx(PHOTO_H_CM);
    const IMG_COL_WIDTH = Math.round(cmToPx(COL_W_CM) * 0.14); // ≃29.1 unités
    const TARGET_RATIO = TARGET_W / TARGET_H;

    // stockage
    let images = [null, null], lastSatB64 = null;
    const points = {};

    // initialisation dropdown point
    for (let i=1; i<=40; i++) {
      pointSelect.add(new Option(`P${i}`, `P${i}`));
    }
    pointSelect.addEventListener('change', () => {
      btnSave.textContent = pointSelect.value ? `Enregistrer ${pointSelect.value}` : 'Enregistrer';
    });

    // date/heure par défaut
    function nowLocal(){
      const d = new Date();
      d.setSeconds(0,0);
      const tz = d.getTimezoneOffset();
      return new Date(d.getTime() - tz*60000).toISOString().slice(0,16);
    }
    datetimeEl.value = nowLocal();

    // conversion décimal → DMS
    const toDMS = v => {
      const deg = Math.floor(v), min = Math.floor((v-deg)*60),
            sec = Math.round((v-deg-min/60)*3600);
      return `${deg}°${min}'${sec}"`;
    };

    // gestion erreurs
    function showErrors(arr){
      errorsDiv.innerHTML = `<ul>${arr.map(e=>`<li>${e}</li>`).join('')}</ul>`;
    }
    function clearErrors(){ errorsDiv.innerHTML = ''; }

    // --- Prise de photos (Code 1) ---
    async function processFile(file, idx) {
      // 1. DataURL
      const dataURL = await new Promise(res => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.readAsDataURL(file);
      });
      // 2. EXIF normalize
      const { canvas: norm } = await new Promise((res, rej) => {
        loadImage(dataURL, img => res({ canvas: img }), { orientation:true, canvas:true });
      });
      // 3. crop center ratio
      const w = norm.width, h = norm.height;
      let sx, sy, sw, sh;
      if (w/h > TARGET_RATIO) {
        sh = h; sw = h*TARGET_RATIO; sx = (w-sw)/2; sy = 0;
      } else {
        sw = w; sh = w/TARGET_RATIO; sx = 0; sy = (h-sh)/2;
      }
      // 4. draw into target canvas
      const tgt = document.createElement('canvas');
      tgt.width = TARGET_W; tgt.height = TARGET_H;
      const ctx = tgt.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(norm, sx, sy, sw, sh, 0, 0, TARGET_W, TARGET_H);
      // 5. to ArrayBuffer PNG
      return new Promise((res, rej) => {
        tgt.toBlob(blob => {
          const fr = new FileReader();
          fr.onload = () => res(fr.result);
          fr.onerror = rej;
          fr.readAsArrayBuffer(blob);
        }, 'image/png');
      });
    }

    // bind boutons photos
    photo1Btn.addEventListener('click', () => photo1.click());
    photo2Btn.addEventListener('click', () => photo2.click());
    photo1.addEventListener('change', async () => {
      images[0] = await processFile(photo1.files[0], 0);
      photo1Btn.classList.add('filled');
      if (images[1] && lastSatB64) btnExport.disabled = false;
    });
    photo2.addEventListener('change', async () => {
      images[1] = await processFile(photo2.files[0], 1);
      photo2Btn.classList.add('filled');
      if (images[0] && lastSatB64) btnExport.disabled = false;
    });

    // --- Géoloc + adresse + DMS + vue satellite ---
    btnGeo.addEventListener('click', () => {
      clearErrors();
      if (!navigator.geolocation) {
        return showErrors(['Géolocalisation non supportée']);
      }
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        // OSM reverse
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
        );
        const d = await res.json(), a = d.address||{};
        addressEl.value = `${a.house_number||''} ${a.oad||''}`.trim()
                          + ', ' + (a.city||a.town||a.village||a.county||'');
        latEl.value = toDMS(latitude);
        lngEl.value = toDMS(longitude);
        // satellite
        lastSatB64 = await (async () => {
          const reqW = TARGET_W, reqH = TARGET_H*2, zoom = 17;
          const url =
            `https://maps.googleapis.com/maps/api/staticmap`
            + `?center=${latitude},${longitude}`
            + `&markers=color:red|${latitude},${longitude}`
            + `&scale=2`
            + `&zoom=${zoom}`
            + `&size=${reqW}x${reqH}`
            + `&maptype=satellite`
            + `&key=AIzaSyCbP5xIyt4PCn-tzJpr3sOJd2BO7gV43-w`;
          const img = new Image();
          img.crossOrigin = 'Anonymous';
          img.src = url;
          await img.decode();
          const c = document.createElement('canvas');
          c.width = TARGET_W; c.height = TARGET_H;
          const cx = c.getContext('2d');
          cx.drawImage(img, 0, 0, reqW, TARGET_H, 0, 0, TARGET_W, TARGET_H);
          return c.toDataURL('image/png').split(',')[1];
        })();
        if (images[0] && images[1]) btnExport.disabled = false;
      }, e => showErrors([`Erreur position : ${e.message}`]));
    });

    // --- Sauvegarde local des données ---
    btnSave.addEventListener('click', () => {
      clearErrors();
      const errs = [];
      if (!pointSelect.value)            errs.push('Sélectionner un point.');
      if (!typologySelect.value)         errs.push('Sélectionner une typologie.');
      if (!datetimeEl.value)             errs.push('Date & heure requises.');
      if (!no2El.value && !c6h6El.value && !pm10El.value)
                                          errs.push('Au moins une mesure de capteur.');
      if (!images[0] || !images[1])       errs.push('Les deux photos sont obligatoires.');
      if (!lastSatB64)                   errs.push('Vue satellite manquante (cliquer sur « Obtenir adresse »).');
      if (errs.length) return showErrors(errs);

      points[pointSelect.value] = {
        typology: typologySelect.value,
        address:  addressEl.value,
        lat:      latEl.value,
        lng:      lngEl.value,
        no2:      no2El.value,
        c6h6:     c6h6El.value,
        pm10:     pm10El.value,
        datetime: datetimeEl.value,
        img1:     images[0],
        img2:     images[1],
        sat:      lastSatB64
      };

      // reset UI
      pointSelect.value = '';
      typologySelect.value = '';
      addressEl.value = latEl.value = lngEl.value = '';
      no2El.value = c6h6El.value = pm10El.value = '';
      datetimeEl.value = nowLocal();
      photo1Btn.classList.remove('filled');
      photo2Btn.classList.remove('filled');
      images = [null,null]; lastSatB64 = null;
      btnSave.textContent = 'Enregistrer';
      clearErrors();
      alert('Données enregistrées !');
    });

    // --- Export XLSX ---
    btnExport.addEventListener('click', async () => {
      if (!confirm('Tu es sûr ? Sauvegarder réinitialise l’app.')) return;
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet('Mesures');

      // colonnes avant images
      ws.columns = [
        { header:'Point',       key:'point',    width:10 },
        { header:'Typologie',   key:'typology', width:15 },
        { header:'Adresse',     key:'address',  width:30 },
        { header:'Lat DMS',     key:'lat',      width:15 },
        { header:'Lng DMS',     key:'lng',      width:15 },
        { header:'NO₂',         key:'no2',      width:10 },
        { header:'C₆H₆',        key:'c6h6',     width:10 },
        { header:'PM₁₀',        key:'pm10',     width:10 },
        { header:'DateHeure',   key:'datetime', width:20, style:{ numFmt:'dd/mm/yy hh:mm' } },
        // colonnes images 5,5 cm
        { header:'Photo 1',     key:'photo1',   width:IMG_COL_WIDTH },
        { header:'Photo 2',     key:'photo2',   width:IMG_COL_WIDTH },
        { header:'Vue sat.',    key:'sat',      width:IMG_COL_WIDTH }
      ];

      let rowIdx = 2;
      for (const [pt,p] of Object.entries(points)) {
        ws.addRow({
          point:     pt,
          typology:  p.typology,
          address:   p.address,
          lat:       p.lat,
          lng:       p.lng,
          no2:       p.no2,
          c6h6:      p.c6h6,
          pm10:      p.pm10,
          datetime:  new Date(p.datetime)
        });
        ws.getRow(rowIdx).height = TARGET_H * 0.75;

        // Photo 1
        if (p.img1) {
          const id1 = wb.addImage({ buffer: p.img1, extension:'png' });
          ws.addImage(id1, {
            tl:  { col: 9, row: rowIdx-1 },
            ext: { width: TARGET_W, height: TARGET_H }
          });
        }
        // Photo 2
        if (p.img2) {
          const id2 = wb.addImage({ buffer: p.img2, extension:'png' });
          ws.addImage(id2, {
            tl:  { col:10, row: rowIdx-1 },
            ext: { width: TARGET_W, height: TARGET_H }
          });
        }
        // Vue sat.
        if (p.sat) {
          const id3 = wb.addImage({ base64: p.sat, extension:'png' });
          ws.addImage(id3, {
            tl:  { col:11, row: rowIdx-1 },
            ext: { width: TARGET_W, height: TARGET_H }
          });
        }
        rowIdx++;
      }

      // write & download
      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf]), `${affaireEl.value||'Sans_affaire'}_Fiche_de_points_de_mesure.xlsx`);

      // reset et reload
      Object.keys(points).forEach(k=>delete points[k]);
      location.reload();
    });
  });
  </script>
</body>
</html>
